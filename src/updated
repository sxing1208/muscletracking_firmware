#include <Arduino.h>
#include <Wire.h>
#include <ArduinoBLE.h>
// BLE Service and Characteristics
BLEService bleService("180C");
BLECharacteristic qCharacteristic("2A6F", BLERead | BLEWrite, 20);
BLECharacteristic rCharacteristic("2A70", BLERead | BLEWrite, 20);
BLECharacteristic xCharacteristic("2A71", BLERead | BLEWrite, 20);
BLECharacteristic yCharacteristic("2A72", BLERead | BLEWrite, 20);
BLECharacteristic zCharacteristic("2A73", BLERead | BLEWrite, 20);
BLECharacteristic aCharacteristic("2A74", BLERead | BLEWrite, 20);
BLECharacteristic bCharacteristic("2A75", BLERead | BLEWrite, 20);

// I2C pins for ESP32-S3
#define SDA_PIN 8
#define SCL_PIN 9

// LSM6DSOX I2C address
#define LSM6DSOX_ADDR 0x6A

// Registers
#define WHO_AM_I    0x0F
#define CTRL1_XL    0x10
#define CTRL2_G     0x11
#define OUTX_L_G    0x22  // 6 gyro registers start here
#define OUTX_L_A    0x28  // 6 accel registers start here

// Analog pins
const int analogPins[] = {6, 7, 10, 11};

// Write a register
void writeRegister(uint8_t reg, uint8_t value) {
  Wire.beginTransmission(LSM6DSOX_ADDR);
  Wire.write(reg);
  Wire.write(value);
  Wire.endTransmission();
}

// Read multiple bytes
void readRegisters(uint8_t reg, uint8_t *data, uint8_t len) {
  Wire.beginTransmission(LSM6DSOX_ADDR);
  Wire.write(reg);
  Wire.endTransmission(false); // repeated start
  Wire.requestFrom(LSM6DSOX_ADDR, len);
  for (int i = 0; i < len; i++) {
    if (Wire.available()) {
      data[i] = Wire.read();
    }
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);

  Wire.begin(SDA_PIN, SCL_PIN);
  Wire.setClock(100000); // 100 kHz safe start

  // WHO_AM_I check
  uint8_t whoami = 0;
  readRegisters(WHO_AM_I, &whoami, 1);
  Serial.print("WHO_AM_I = 0x");
  Serial.println(whoami, HEX);

  if (whoami != 0x6C) {
    Serial.println("⚠️ LSM6DSOX not found!");
    while (1) delay(100);
  }

  // Configure accelerometer: 104 Hz, ±2 g
  writeRegister(CTRL1_XL, 0b01000000); // ODR=104 Hz, FS=2g

  // Configure gyroscope: 104 Hz, ±2000 dps
  writeRegister(CTRL2_G, 0b01001100); // ODR=104 Hz, FS=2000 dps

  // Initialize analog pins
  for (int i = 0; i < 4; i++) {
    pinMode(analogPins[i], INPUT);
  }

  //BLE initialization
    if (!BLE.begin())
  {
    while (1)
      ;
  }
  BLE.setDeviceName("Muscle_Sensor");
  BLE.setLocalName("Muscle_Sensor");
  BLE.setAdvertisedService(bleService);
  bleService.addCharacteristic(qCharacteristic);
  bleService.addCharacteristic(rCharacteristic);
  bleService.addCharacteristic(xCharacteristic);
  bleService.addCharacteristic(yCharacteristic);
  bleService.addCharacteristic(zCharacteristic);
  bleService.addCharacteristic(aCharacteristic);
  bleService.addCharacteristic(bCharacteristic);
  BLE.addService(bleService);
  BLE.advertise();

  delay(100);
}

void loop() {
  BLE.poll();

  uint8_t rawData[6];
  int16_t gx, gy, gz, ax, ay, az;

  // Gyroscope
  readRegisters(OUTX_L_G, rawData, 6);
  gx = (int16_t)(rawData[1] << 8 | rawData[0]);
  gy = (int16_t)(rawData[3] << 8 | rawData[2]);
  gz = (int16_t)(rawData[5] << 8 | rawData[4]);

  // Accelerometer
  readRegisters(OUTX_L_A, rawData, 6);
  ax = (int16_t)(rawData[1] << 8 | rawData[0]);
  ay = (int16_t)(rawData[3] << 8 | rawData[2]);
  az = (int16_t)(rawData[5] << 8 | rawData[4]);

  // Convert to physical units
  float ax_mg = ax * 0.061f;
  float ay_mg = ay * 0.061f;
  float az_mg = az * 0.061f;

  float gx_dps = gx * 0.07f;
  float gy_dps = gy * 0.07f;
  float gz_dps = gz * 0.07f;

  // Analog reads
  int analogVals[4];
  for (int i = 0; i < 4; i++) {
    analogVals[i] = analogRead(analogPins[i]);
  }

  Serial.print(ax_mg); Serial.print(", ");
  Serial.print(ay_mg); Serial.print(", ");
  Serial.print(az_mg); Serial.print(", ");

  for (int i = 0; i < 4; i++) {
    Serial.print(analogVals[i]);
    if (i < 3) Serial.print(", ");
  }
  float data[7]; 

  data[0] = ax_mg;
  data[1] = ay_mg;
  data[2] = az_mg;
  data[3] = analogVals[0];
  data[4] = analogVals[1];
  data[5] = analogVals[2];
  data[6] = analogVals[3];

  qCharacteristic.writeValue((uint16_t*)&data[0], sizeof(data[0]));
  rCharacteristic.writeValue((uint16_t*)&data[1], sizeof(data[1]));
  xCharacteristic.writeValue((uint16_t*)&data[2], sizeof(data[2]));
  yCharacteristic.writeValue((uint16_t*)&data[3], sizeof(data[3]));
  zCharacteristic.writeValue((uint16_t*)&data[4], sizeof(data[4]));
  aCharacteristic.writeValue((uint16_t*)&data[5], sizeof(data[5]));
  bCharacteristic.writeValue((uint16_t*)&data[6], sizeof(data[6]));

  Serial.print("AX: "); Serial.print(ax_mg);
  Serial.print(" AY: "); Serial.print(ay_mg);
  Serial.print(" AZ: "); Serial.print(az_mg);

  Serial.print(" GX: "); Serial.print(gx_dps);
  Serial.print(" GY: "); Serial.print(gy_dps);
  Serial.print(" GZ: "); Serial.print(gz_dps);

  Serial.print(" A0: "); Serial.print(analogVals[0]);
  Serial.print(" A1: "); Serial.print(analogVals[1]);
  Serial.print(" A2: "); Serial.print(analogVals[2]);
  Serial.print(" A3: "); Serial.println(analogVals[3]);

  delay(100);
}
